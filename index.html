<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <!-- Optional: Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css" />

    <title>✨ Bilder (●'◡'●)</title>

</head>

<body class="text-light">
    <!-- Alpine.js Component Scope -->
    <div x-data="imageGallery()" x-init="initGallery()" @keydown.escape.window="closeModal()">
        <div class="container py-4">

            <!-- Current Playing Display - Positioned absolutely at the very top left -->
            <!-- Now Playing: fixed, safe spacing, one-line truncation, accessible -->
            <div class="position-fixed start-0 top-0 p-3 now-playing-container" aria-live="polite">
                <template x-if="currentPlaying">
                    <div class="d-flex align-items-center gap-3 rounded-3 shadow-lg now-playing-dialog">
                        <span class="text-light fw-semibold text-nowrap">Now Playing</span>

                        <button class="btn btn-sm btn-outline-light d-inline-flex align-items-center"
                            :class="{ active: currentPlaying }" @click="stopMusic()" title="Pause music"
                            aria-label="Pause music" style="--bs-btn-border-color: rgba(255,255,255,.35)">
                            <i class="bi bi-pause-fill fs-5 lh-1"></i>
                        </button>

                        <div class="text-light flex-grow-1 overflow-hidden">
                            <div class="fw-semibold text-truncate"
                                x-text="getCurrentTrackInfo().name || 'Unknown Track'"
                                x-bind:title="getCurrentTrackInfo().name || 'Unknown Track'"></div>
                            <div class="text-white-50 small text-truncate"
                                x-text="getCurrentTrackInfo().artist || 'Unknown Artist'"
                                x-bind:title="getCurrentTrackInfo().artist || 'Unknown Artist'"></div>
                        </div>

                        <!-- Arrow link to the currently playing element -->
                        <a :href="'#element-' + getCurrentTrackInfo().index"
                            class="text-decoration-none text-light d-inline-flex align-items-center"
                            title="Go to element" aria-label="Go to element" style="opacity: 0.9">
                            <i class="bi bi-arrow-right-circle-fill fs-5"></i>
                        </a>
                    </div>
                </template>
            </div>

            <header class="container">
                <h2 class="text-center mb-1">
                    Images! - <span x-text="romanCount"></span><sup x-text="actualCount"></span>
                        <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank"
                            rel="noopener noreferrer">
                            <img src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/cc-zero.png"
                                alt="Creative Commons Public Domain Zero"
                                style="vertical-align: middle; margin-left: 10px; height: 2rem;" /></a>
                </h2>
                <h5 class="text-center mb-4">
                    All images are in the public domain under the CC0 1.0 Universal
                    license.
                </h5>
                <h6 class="text-center mb-4"><a href="https://creativecommons.org/publicdomain/zero/1.0/"
                        target="_blank" rel="noopener noreferrer">more about the license</a></h6>
            </header>

            <!-- Subtle Autoplay Button (only shown when browser blocks autoplay) -->
            <template x-if="showAutoplayButton && !currentPlaying">
                <div class="text-center mb-3">
                    <button class="btn btn-outline-light btn-sm" @click="playRandomMusic(); showAutoplayButton = false;">
                        <i class="bi bi-play-fill me-1"></i>
                        Enable Music
                    </button>
                </div>
            </template>
            <!-- Loading State -->
            <template x-if="loading">
                <div class="d-flex justify-content-center my-5">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="error">
                <div class="alert alert-danger" role="alert" x-text="error"></div>
            </template>

            <div class="gallery-row d-flex" :class="`columns-${columnCount}`">
                <template x-for="(column, colIdx) in columns" :key="colIdx">
                    <div class="gallery-col flex-fill d-flex flex-column" style="gap: 1rem;">
                        <template x-for="(image, index) in column" :key="image.index">
                            <div x-data="{
                                    visible: false,
                                    observe(el) {
                                        let observer = new IntersectionObserver(
                                            (entries, obs) => {
                                                if (entries[0].isIntersecting) {
                                                    this.visible = true;
                                                    obs.disconnect();
                                                }
                                            },
                                            { rootMargin: '200px' } // Preload just before in view
                                        );
                                        observer.observe(el);
                                    }
                                }" x-init="observe($el)" :id="'element-' + image.index"
                                class="card bg-dark text-white border-secondary position-relative"
                                style="min-height: 200px;">
                                <template x-if="visible">
                                    <img :src="image.urls.webp" class="card-img" :alt="'Art Image ' + image.index"
                                        loading="lazy" />
                                </template>
                                <template x-if="!visible">
                                    <div class="d-flex align-items-center justify-content-center" style="height:200px;">
                                        <div class="spinner-border text-light" role="status"></div>
                                    </div>
                                </template>

                                <!-- Play Button for Music Entries -->
                                <template x-if="image.urls.mp3">
                                    <button class="play-button"
                                        :class="{ 'playing': currentPlaying === image.urls.mp3 }"
                                        @click="playMusic(image.urls.mp3, image.index)"
                                        :title="currentPlaying === image.urls.mp3 ? 'Stop Music' : 'Play Music'">
                                        <i x-show="currentPlaying !== image.urls.mp3" class="bi bi-play-fill"></i>
                                        <i x-show="currentPlaying === image.urls.mp3" class="bi bi-pause-fill"></i>
                                    </button>
                                </template>

                                <!-- Overlay for Buttons -->
                                <div class="card-img-overlay p-0">
                                    <div class="action-buttons">
                                        <!-- View Link (Opens in New Tab) -->
                                        <a :href="image.urls.hq" target="_blank" rel="noopener noreferrer"
                                            class="btn btn-sm btn-outline-light" title="View Full Size">
                                            <i class="bi bi-eye-fill"></i>
                                        </a>
                                        <!-- Download Button -->
                                        <button type="button" class="btn btn-sm btn-outline-light"
                                            @click="downloadImage($event.target, image.urls.hq)"
                                            :disabled="downloading === image.urls.hq">
                                            <span x-show="downloading === image.urls.hq"
                                                class="spinner-border spinner-border-sm" role="status"
                                                aria-hidden="true"></span>
                                            <i x-show="downloading !== image.urls.hq" class="bi bi-download"></i>
                                        </button>
                                        <!-- Music Link Button -->
                                        <template x-if="image.urls.music">
                                            <a :href="image.urls.music" target="_blank" rel="noopener noreferrer"
                                                class="btn btn-sm btn-outline-light" title="Listen on Music Platform">
                                                <i class="bi bi-music-note-beamed"></i>
                                            </a>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>





            <!-- Bootstrap Bundle JS (includes Popper) -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
                crossorigin="anonymous"></script>

            <script>
                // Helper function (can stay outside Alpine component)
                function toRoman(num) {
                    const romanNumerals = [
                        { value: 1000, numeral: "M" }, { value: 900, numeral: "CM" },
                        { value: 500, numeral: "D" }, { value: 400, numeral: "CD" },
                        { value: 100, numeral: "C" }, { value: 90, numeral: "XC" },
                        { value: 50, numeral: "L" }, { value: 40, numeral: "XL" },
                        { value: 10, numeral: "X" }, { value: 9, numeral: "IX" },
                        { value: 5, numeral: "V" }, { value: 4, numeral: "IV" },
                        { value: 1, numeral: "I" },
                    ];
                    let result = "";
                    if (typeof num !== "number" || num < 1) return "";
                    for (const { value, numeral } of romanNumerals) {
                        while (num >= value) {
                            result += numeral;
                            num -= value;
                        }
                    }
                    return result;
                }

                // Alpine.js data and methods
                function imageGallery() {
                    return {
                        images: [],
                        loading: true,
                        error: null,
                        modalInstance: null,
                        modalImageUrl: "",
                        downloading: null,
                        columnCount: 3, // default
                        currentPlaying: null,
                        audioElement: null,
                        showAutoplayButton: false,

                        get romanCount() {
                            return toRoman(this.images.length);
                        },
                        get actualCount() {
                            return `(${this.images.length})`;
                        },

                        get columns() {
                            // Split images into N columns, row-wise
                            const cols = Array.from({ length: this.columnCount }, () => []);
                            this.images.forEach((img, i) => {
                                cols[i % this.columnCount].push(img);
                            });
                            return cols;
                        },

                        updateColumnCount() {
                            // Responsive: 1, 2, or 3 columns
                            const w = window.innerWidth;
                            if (w < 768) this.columnCount = 1;
                            else if (w < 992) this.columnCount = 2;
                            else this.columnCount = 3;
                        },

                        initGallery() {
                            this.updateColumnCount();
                            window.addEventListener("resize", () => {
                                this.updateColumnCount();
                            });
                            this.$nextTick(() => {
                                if (this.$refs.modalElement) {
                                    this.modalInstance = new bootstrap.Modal(
                                        this.$refs.modalElement
                                    );
                                    this.$refs.modalElement.addEventListener(
                                        "hidden.bs.modal",
                                        () => {
                                            this.modalImageUrl = "";
                                        }
                                    );
                                }
                            });
                            this.fetchImages();
                        },

                        fetchImages() {
                            this.loading = true;
                            this.error = null;
                            fetch("combined_url_mapping.json")
                                .then((response) => {
                                    if (!response.ok) {
                                        throw new Error(
                                            `HTTP error! Status: ${response.status}`
                                        );
                                    }
                                    return response.json();
                                })
                                .then((urlMapping) => {
                                    this.images = Object.entries(urlMapping)
                                        .map(([index, urls]) => ({ index, urls }))
                                        .sort(() => Math.random() - 0.5); // Randomize order
                                    this.loading = false;

                                    // Try to auto-play random music after images load (respects browser policies)
                                    this.attemptAutoplay();
                                })
                                .catch((error) => {
                                    console.error("Error loading the URL mapping:", error);
                                    this.error =
                                        "Sorry, there was an error loading the images.";
                                    this.loading = false;
                                });
                        },

                        // Attempt to autoplay music while respecting browser policies
                        async attemptAutoplay() {
                            try {
                                const canAutoplay = await this.canAutoplay();
                                if (canAutoplay) {
                                    this.playRandomMusic();
                                    this.showAutoplayButton = false; // Hide button if autoplay works
                                } else {
                                    // Only show button if browser actually blocks autoplay
                                    console.log('Browser blocked autoplay, showing manual play button');
                                    this.showAutoplayButton = true;
                                }
                            } catch (error) {
                                // Only show button on actual autoplay errors, not other errors
                                if (error.name === 'NotAllowedError' || error.name === 'NotSupportedError') {
                                    console.log('Autoplay blocked by browser policy');
                                    this.showAutoplayButton = true;
                                } else {
                                    console.log('Other error occurred, not showing autoplay button');
                                    this.showAutoplayButton = false;
                                }
                            }
                        },

                        playRandomMusic() {
                            // Get all images that have MP3 files
                            const musicImages = this.images.filter(img => img.urls.mp3);

                            if (musicImages.length > 0) {
                                // Randomly select one music track
                                const randomMusic = musicImages[Math.floor(Math.random() * musicImages.length)];

                                // Try to play the randomly selected music (respects autoplay policies)
                                this.playMusic(randomMusic.urls.mp3, randomMusic.index);
                            }
                        },

                        // Check if autoplay is allowed by the browser
                        canAutoplay() {
                            // Modern browsers block autoplay by default
                            // We'll try to play a silent audio to test if autoplay is allowed
                            return new Promise((resolve) => {
                                const testAudio = new Audio();
                                testAudio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT';
                                testAudio.volume = 0;
                                testAudio.play().then(() => {
                                    testAudio.pause();
                                    resolve(true);
                                }).catch(() => {
                                    resolve(false);
                                });
                            });
                        },

                        playMusic(mp3Url, imageIndex) {
                            // If clicking the same music that's playing, stop it
                            if (this.currentPlaying === mp3Url) {
                                this.stopMusic();
                                return;
                            }

                            // Stop any currently playing music
                            this.stopMusic();

                            // Create new audio element
                            this.audioElement = new Audio(mp3Url);
                            this.currentPlaying = mp3Url;

                            // Enable looping
                            this.audioElement.loop = true;

                            // Play the music
                            this.audioElement.play().catch(error => {
                                console.error('Error playing audio:', error);
                                this.currentPlaying = null;
                            });

                            // Handle errors
                            this.audioElement.addEventListener('error', (error) => {
                                console.error('Audio error:', error);
                                this.currentPlaying = null;
                            });
                        },

                        stopMusic() {
                            if (this.audioElement) {
                                this.audioElement.pause();
                                this.audioElement.currentTime = 0;
                                this.audioElement = null;
                            }
                            this.currentPlaying = null;
                        },

                        getCurrentTrackInfo() {
                            if (!this.currentPlaying) return { name: '', artist: '', index: '' };

                            // Extract track info from the MP3 URL
                            // Assuming URL format contains track info or we can get it from the image data
                            const currentImage = this.images.find(img => img.urls.mp3 === this.currentPlaying);
                            if (currentImage) {
                                // Use the actual title if available, otherwise fallback to track number
                                const trackName = currentImage.urls.title || `Track ${currentImage.index}`;
                                return {
                                    name: trackName,
                                    artist: '_yay_kay_',
                                    index: currentImage.index
                                };
                            }

                            return {
                                name: 'Unknown Track',
                                artist: '_yay_kay_',
                                index: ''
                            };
                        },

                        downloadImage(buttonElement, url) {
                            if (this.downloading) return; // Prevent multiple downloads

                            this.downloading = url; // Set downloading state for this URL

                            fetch(url, { mode: "cors" }) // Ensure CORS is handled if images are cross-origin
                                .then((response) => {
                                    if (!response.ok)
                                        throw new Error(
                                            `Network response was not ok (${response.status})`
                                        );
                                    return response.blob();
                                })
                                .then((blob) => {
                                    const blobUrl = window.URL.createObjectURL(blob);
                                    const a = document.createElement("a");
                                    a.style.display = "none";
                                    a.href = blobUrl;
                                    // Try to extract a filename, default to 'download.jpg'
                                    const filename = url.split("/").pop().split('?')[0] || "download.jpg"; // Basic filename extraction
                                    a.download = filename;
                                    document.body.appendChild(a);
                                    a.click();
                                    // Cleanup timeout
                                    setTimeout(() => {
                                        document.body.removeChild(a);
                                        window.URL.revokeObjectURL(blobUrl);
                                        this.downloading = null; // Clear downloading state
                                    }, 100); // 100ms delay for safety
                                })
                                .catch((err) => {
                                    console.error("Download failed:", err);
                                    alert("Download failed: " + err.message); // User feedback
                                    this.downloading = null; // Clear downloading state on error
                                });
                        },
                    };
                }
            </script>
</body>

</html>
